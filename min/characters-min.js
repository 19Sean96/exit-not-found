const weapons=[["Brass knuckles","Fists"],[""],["Pistol","Rifle","Sniper"]],enemyType=["Skeleton ðŸ’€","Vampire ðŸ§›","Wizard ðŸ§™","Demon ðŸ‘¹"],Character=function(e,t){const a=this;a.class=t,a.name=e,a.xp=0,a.nextLvl=100,a.lvl=1,a.hp=t?1==t?50:75:100,a.maxHp=a.hp,a.attackStrength=t&&1!=t?rng(3)+1:rng()+3,a.def=t?1==t?rng(2)+1:rng(3)+1:rng()+2,a.crit={mult:1.5,chance:10},a.agility=t?1==t?rng(2)+1:rng(5)+3:rng()+2,a.actionsPerTurn=t&&1==t?rng(2)+3:rng()+4,a.actionsLeft=a.actionsPerTurn,a.attackSpeed=~~(a.attackStrength/2)||1,a.fov=t?rng(3)+2:rng(2)+1,a.fov=Math.ceil(Math.sqrt(a.fov*a.fov+a.fov*a.fov)),a.accuracy=a.class?1==a.class?60+rng(41):75+rng(6):65+rng(26),a.items=[],a.awaitingUser=!1,a.checkIfNextLvl=function(){a.nextLvl-a.xp<=0&&a.lvlUp()},a.lvlUp=function(){a.nextLvl+=a.nextLvl+Math.pow(a.lvl,3),a.lvl++,a.awaitingUser=!0,_lvlUp.classList.remove("invisible"),a.maxHp*=1.1,zzfxP(levelUpSound[rng(levelUpSound.length-1)]),window.removeEventListener("onkeypress",handleKeyPress)},a.weapons=weapons[a.class],a.addStat=function(e){if(0==e){const e=Math.ceil(1.2*a.attackStrength);createChatMessage("player",a.name,`I increased my attack strength by ${e-a.attackStrength}!`),a.attackStrength=e}else if(1==e){const e=Math.ceil(1.1*a.agility);createChatMessage("player",a.name,`I increased my agility by ${e-a.agility}!`),a.agility=e}else if(2==e){const e=Math.ceil(1.15*a.def);createChatMessage("player",a.name,`I increased my defense by ${e-a.def}!`),a.def=e}else if(3==e){const e=Math.ceil(1.1*a.actionsPerTurn);createChatMessage("player",a.name,`I increased my actions per turn by ${e-a.actionsPerTurn}!`),a.actionsPerTurn=e,a.actionsLeft=e}_lvlUp.classList.add("invisible"),a.awaitingUser=!1,window.addEventListener("keypress",handleKeyPress)},a.coords=playerCoord,a.highlighted=0,a.hiliteMoveArea=function(){const e=[a.coords];for(let t=0;t<a.actionsLeft;t++)e.forEach(([t,n])=>{[[t,n-TILE_HEIGHT],[t+TILE_HEIGHT,n],[t,n+TILE_HEIGHT],[t-TILE_HEIGHT,n]].filter(([e,t])=>"COORDINATES[x]?.[y]?.hasBeenSeen").forEach(([t,n])=>{t==a.coords[0]&&n==a.coords[1]||(COORDINATES[t][n].highlighted=1,e.push([t,n]))})});e.forEach(([e,t],a)=>{a&&(ctx.clearRect(e,t,TILE_HEIGHT,TILE_HEIGHT),ctx.fillStyle=colors.walkHighlight,ctx.fillRect(e,t,TILE_HEIGHT,TILE_HEIGHT))})},a.attackEnemy=async function(e){const t=["I'm tired....","Can I take a moment rest first?","If you want me to do something...I need more actions!"];if(a.attackSpeed>a.actionsLeft)return t[rng(t.length)];const n=a.accuracy-e.agility>=rng(100)&&a.attackStrength>e.def+e.block;a.actionsLeft-=a.attackSpeed;const c=rng(100)<=a.crit.chance?Math.ceil(a.crit.mult*a.attackStrength):a.attackStrength;if(n?(e.hp-=c-e.def-e.block,zzfxP(playerAttackSounds[player.class][rng(playerAttackSounds[player.class].length-1)])):c<=e.block+e.def?zzfxP(blockSound[rng(blockSound.length-1)]):zzfxP(missedSound[rng(missedSound.length-1)]),e.hp<1){const[t,n]=e.coords;COORDINATES[t][n].occupied=0,enemies.splice(enemyIndex,1),a.xp+=e.xp,_cursorModal.classList.add("invisible"),enemies.length||(a.actionsLeft=a.actionsPerTurn),a.checkIfNextLvl()}if(showHoveredDetails(e),0==a.actionsLeft){for(;a.awaitingUser;){await checkIfWaiting()}enemyTurn(exit)}return paintCanvas(),a.hiliteMoveArea(),c<=e.block+e.def?e.name+" blocked your attack!":n&&e.hp<1?`I defeated the ${e.name} by dealing ${c-e.def-e.block} damage!`:n?`I hit the ${e.name} for ${c-e.def-e.block}!`:`I missed the ${e.name}!`},a.inRange=[],a.checkFOV=function(){a.inRange=[],enemies.forEach(e=>{inRange(a.coords,e.coords,a.fov)&&(e.hasBeenSpotted=1,a.inRange.push(e))})},a.block=0,a.resetActions=function(){a.actionsLeft=a.actionsPerTurn,a.block=0},a.defStance=async function(){if(enemies.length){for(a.block=~~(a.actionsLeft/2),a.actionsLeft=0;a.awaitingUser;){await checkIfWaiting()}return paintCanvas(),enemyTurn()}}},Enemy=function(e,t){const a=this,n=rng(100);a.coords=e,a.class=n<60?0:n<85?2:1,a.name=enemyType[rng(3)],a.hp=Math.floor(Math.sqrt(t))+~~(t/10),a.agility=a.class?1==a.class?rng(2)+1:rng(5)+3:rng()+2,a.attackStrength=a.class&&1!=a.class?~~(t/(rng(11)+20)):Math.ceil(t/(rng(11)+10)),a.attackSpeed=~~(a.attackStrength/2)-1>0?~~(a.attackStrength/2)-1:1,a.accuracy=a.class?1==a.class?60+rng(41):75+rng(6):65+rng(26),a.def=a.class?0:~~(t/(rng(21)+40)),a.fov=a.class?rng()+4:rng(2)+2,a.speed=0==a.class?6:1==a.class?3:4,a.speedLeft=a.speed,a.playerSpotted=0,a.hasBeenSpotted,a.xp=~~(t/5),a.crit={mult:2,chance:60},a.atkChar=function(e,t,n){const[c,o]=a.coords,r=rng(100),s=["uhhhhh....why am I bleeding?!","ouch....what was that?","is someone there...stop throwing stuff at me!!","ok....I can't even see you.","oh voice of the cave, please stop hurting me."],i=a.accuracy-player.agility>=r&&player.def+player.block<a.attackStrength,l=rng(100)<=a.crit.chance?a.attackStrength*a.crit.mult:a.attackStrength;i&&(player.hp-=l-~~player.def-player.block),a.speedLeft-=a.attackSpeed;const d=l-player.block-player.def,h=player.def+player.block>=l?`${player.name} blocked ${a.name}'s attack!`:i&&a.attackStrength!=l?"hehehehehe....get crit'd. you just got hit for "+d:i?`just hit you for ${d}!`:"I missed!";if(i?zzfxP(enemyAttackSounds[a.class][rng(enemyAttackSounds[a.class].length-1)]):player.def+player.block>=a.attackStrength&&a.accuracy-player.agility>=r?zzfxP(blockSound[rng(blockSound.length-1)]):a.accuracy-player.agility<r&&zzfxP(missedSound[rng(missedSound.length-1)]),player.inRange.some(({coords:[e,t]})=>c==e&&o==t)?(n&&i&&n(1),createChatMessage("enemy",`#${t} - ${a.name}`,h)):i&&!inRange([c,o],player.coords,player.fov)&&(n&&i&&n(1),createChatMessage("player",player.name,`${s[rng(s.length)]}  (-${d} hp)`)),e(),player.hp<1)return clearTimeout(moveTimer),gameOver()},a.handleTurn=function(e,t){const[n,c]=a.coords,o=([e,t])=>exit[0]==e&&exit[1]==t,r=a.checkFOV(),s=a.speedLeft-a.attackSpeed>=0;if(r&&s)return setTimeout(()=>a.atkChar(e,t),2e3);if(r&&rng(100)<=75)return setTimeout(()=>a.defStance(e,t),1400);let i=[{pos:"top",coord:[n,c-TILE_WIDTH],available:"COORDINATES[x]?.[y - TILE_WIDTH]?.walkable",occupied:" COORDINATES[x]?.[y - TILE_WIDTH]?.occupied",checkIfExit:o([n,c-TILE_WIDTH])},{pos:"right",coord:[n+TILE_WIDTH,c],available:"COORDINATES[x + TILE_WIDTH]?.[y]?.walkable",occupied:"COORDINATES[x + TILE_WIDTH]?.[y]?.occupied",checkIfExit:o([n+TILE_WIDTH,c])},{pos:"bottom",coord:[n,c+TILE_WIDTH],available:"COORDINATES[x]?.[y + TILE_WIDTH]?.walkable",occupied:" COORDINATES[x]?.[y + TILE_WIDTH]?.occupied",checkIfExit:o([n,c+TILE_WIDTH])},{pos:"left",coord:[n-TILE_WIDTH,c],available:"COORDINATES[x - TILE_WIDTH]?.[y]?.walkable",occupied:"COORDINATES[x]?.[y - TILE_WIDTH]?.occupied",checkIfExit:o([n-TILE_WIDTH,c])}].filter(e=>e.available&&!e.checkIfExit&&!e.occupied);if(player.checkFOV(),a.speedLeft--,a.playerSpotted){const[e,t]=[player.coords[0]-n,player.coords[1]-c],a=i.filter(a=>"left"==a.pos?e<0:"right"==a.pos?e>0:"top"==a.pos?t<0:"bottom"==a.pos?t>0:void 0);a.length&&(i=a)}const l=rng(i.length);COORDINATES[n][c].occupied=0,a.coords=i.length>0?i[l].coord:a.coords;const{coords:[d,h]}=a;COORDINATES[d][h].occupied=1,setTimeout(()=>{paintCanvas(),zzfxP(eMove[rng(eMove.length-1)]),e()},300)},a.block=0,a.defStance=function(e,t){const n=[e=>"betcha can't hurt me now "+e,e=>`hey ${e}...check out this shield`,e=>"no way you're gonna break this defense "+e];a.block=a.speedLeft,a.speedLeft=0,inRange(a.coords,player.coords,player.fov)&&createChatMessage("enemy",`#${t} - ${a.name}`,n[rng(n.length)](player.name)),e()},a.checkFOV=function(){if(inRange(a.coords,player.coords,a.fov))return a.playerSpotted=1,1;inRange(a.coords,player.coords,a.fov+a.fov)||(a.playerSpotted=0)},a.resetActions=function(){a.speedLeft=a.speed,a.block=0}};
//! player create page
//! add modal for stat update