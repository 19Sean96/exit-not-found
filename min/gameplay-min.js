_btnStart.addEventListener("click",startGame);const handleCanvasHover=e=>{_cursorModal.style.transform=`translate(calc(-25% + ${e.clientX}px),calc(-25% + ${e.clientY}px))`;const{top:t,left:a}=game.getBoundingClientRect(),n=game.width/e.target.clientWidth,r=(e.clientX-a)*n,c=(e.clientY-t)*n,[s]=enemies.filter((e,t)=>{if(checkIfTargetCoord([r,c],e.coords))return enemyIndex=t,1}),l=checkIfTargetCoord([r,c],player.coords);s&&inRange(s.coords,player.coords,player.fov)?(_cursorModal.classList.remove("invisible"),showHoveredDetails(s)):l?(_cursorModal.classList.remove("invisible"),showHoveredDetails(1,1)):(enemyIndex=0,_cursorModal.classList.add("invisible"),_cursorModal.innerHTML="")};game.addEventListener("mousemove",handleCanvasHover);const playerAttack=async()=>{const e=await player.attackEnemy(enemies[enemyIndex]);createChatMessage("player",player.name,e)},showHoveredDetails=(e,t)=>{_cursorModal.innerHTML="";const a=document.querySelector((t?"block":"attack")+"-btn"),n=document.querySelector((t?"block":"attack")+"-btn");a&&a.removeEventListener("click",player.defStance),n&&n.removeEventListener("click",playerAttack);const r=t?{...player}:{...e},c=document.createElement("section");c.classList.add((t?"player":"enemy")+"-item");const s=document.createElement("h4");s.innerHTML=`${r.name} - ${r.class?1==r.class?"Magic":"Ranged":"Melee"}`,c.append(s);const l=t?`${r.hp}/${r.maxHp}`:r.hp,o=document.createElement("div");t&&o.append(createParSpanPair("XP:",`${player.xp}/${player.nextLvl}`)),t&&o.append(document.createElement("br")),o.classList.add((t?"player":"enemy")+"-item-stats"),o.append(createParSpanPair("❤ HP: ",l)),o.append(createParSpanPair("🔪 Attack: ",r.attackStrength)),o.append(createParSpanPair("🔪 Attack Speed: ",r.attackSpeed)),o.append(createParSpanPair("🛡 Defense: ",r.def)),c.append(o);const d=document.createElement("button");d.classList.add((t?"block":"attack")+"-btn","font-bold"),d.innerText=t?"block":"attack",c.append(d),_cursorModal.append(c),d.addEventListener("click",t?player.defStance:playerAttack)},typeName=e=>{startedTyping||(_createNameInput.textContent="",startedTyping=1),_createNameInput.textContent.length>20&&8!=e.keyCode&&46!=e.keyCode?e.preventDefault():e.key.match(/[A-Za-z0-9]/g)&&1==e.key.length?_createNameInput.textContent=_createNameInput.textContent+e.key:8==e.keyCode&&(_createNameInput.textContent=_createNameInput.textContent.substr(0,_createNameInput.textContent.length-1))};window.addEventListener("keydown",typeName);const createParSpanPair=(e,t)=>{const a=document.createElement("p"),n=document.createElement("span");return a.innerHTML=e,n.innerHTML=t,a.append(n),a},checkIfTargetCoord=([e,t],[a,n])=>e>=a&&t>=n&&e<a+TILE_WIDTH&&t<n+TILE_WIDTH;_lvlUp.addEventListener("click",e=>e.target.dataset.stat?player.addStat(e.target.dataset.stat):null),_cursorModal.addEventListener("mouseleave",e=>{enemyIndex=0,_cursorModal.classList.add("invisible")}),_newGameBtn.addEventListener("click",e=>{player=new Character(player.name,player.class),_playAgain.classList.add("invisible"),_chatMessageGroup.innerHTML="",startGame(!0)}),_newCharacterBtn.addEventListener("click",e=>location.reload());