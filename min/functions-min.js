const asyncForEach=async(e,r)=>{for(let t=0;t<e.length;t++){if(player.hp<1)return;await r(e[t],t,e)}},inverseCoords=([e,r])=>e?r?e==xyMax?[0,r]:[e,0]:[e,xyMax]:[xyMax,r],roundUp=e=>{const r=e.toString().split(".")[1];return r&&parseInt(r.split("")[0])>=5?Math.round(e):e},checker=([e,r])=>{const t={...COORDINATES},a=[[e,r]];for(let n=0;n<100;n++){for(let n=0;n<a.length;n++){const[s,o]=a[n],i=[[s,o-TILE_HEIGHT],[s+TILE_HEIGHT,o],[s,o+TILE_HEIGHT],[s-TILE_HEIGHT,o]];for(let n=0;n<i.length;n++){const[s,o]=i[n];if("checkCOORDINATES[x]?.[y]?.walkable"){if(t[s][o].checked||s==e&&o==r)continue;if(t[s][o].exit)return 1;t[s][o].checked=1,a.push(i[n])}}}if(a.length<2)return}},startGame=(e,r)=>{window.removeEventListener("keydown",typeName),window.removeEventListener("keypress",handleKeyPress);const t=document.querySelector('input[name="class"]:checked');_landing.classList.add("invisible"),_btnStart.classList.add("invisible"),_container.classList.remove("invisible"),game.classList.add("p-turn"),player=new Character(_createNameInput.textContent,parseInt(t.value)),r||(player=new Character(_createNameInput.textContent,parseInt(t.value))),game.classList.remove("p-turn"),game.classList.remove("e-turn"),game.classList.add("n-turn"),helpDisabled||(player.awaitingUser=!0,asyncForEach(narrator.start,(e,r,t)=>new Promise(a=>{if(0!=r)return setTimeout(()=>{createChatMessage(4!=r&&5!=r?"narrator":"player",4!=r&&5!=r?"narrator":"player",1!=r?e:e(player.name)),r==t.length-1&&(player.awaitingUser=!1,game.classList.remove("n-turn"),game.classList.add("p-turn")),a()},rng(750)+1500);createChatMessage("narrator","narrator",e(player.name)),a()}))),buildDungeon([0,160])},inRange=([e,r],[t,a],n)=>{const s=Math.abs(e-t)/TILE_HEIGHT,o=Math.abs(r-a)/TILE_HEIGHT;return~~Math.sqrt(s*s+o*o)<=n},getCenterOfCoords=e=>[e.coords[0]+TILE_WIDTH/2,e.coords[1]+TILE_WIDTH/2],generatePlayer=async(e,r,t)=>{for(handleKeyPress=e=>handlePlayerMovement(e,r,t),playerCoord=e,player.coords=e;player.awaitingUser;){await checkIfWaiting()}window.addEventListener("keypress",handleKeyPress)},generateEnemies=(e,r,t)=>{enemies=[],enemyCount=rng(e/2+2);for(let e=0;e<enemyCount;e++){const e=new Enemy(getEnemyStartCoordinate(r,t),~~(totalEnemyPower/enemyCount));enemies.push(e);const{coords:[a,n]}=e;COORDINATES[a][n].occupied=1}player.checkFOV(),paintCanvas(),player.hiliteMoveArea()},getEnemyStartCoordinate=(e,r)=>{const t=rng(NUMBER_OF_ROWS)*TILE_HEIGHT,a=rng(NUMBER_OF_ROWS)*TILE_HEIGHT;return 0!=t&&0!=a&&t!=e&&a!=e?[t,a]:getEnemyStartCoordinate(e,r)},handlePlayerMovement=async(e,r,t)=>{if("KeyW"!=e.code&&"KeyD"!=e.code&&"KeyS"!=e.code&&"KeyA"!=e.code)return;zzfxP(pMove[rng(pMove.length-1)]);let{key:a}=e;a=a.toLowerCase();let[n,s]=playerCoord;const o={w:[n,s-t],d:[n+t,s],s:[n,s+t],a:[n-t,s]},[i,l]=o[a];if(i==exit[0]&&l==exit[1])return await tryAOO()?enemyTurn():(game.classList.remove("e-turn"),game.classList.add("p-turn"),clearTimeout(moveTimer),window.removeEventListener("keypress",handleKeyPress),player.xp+=lvl,lvl++,enemyPowerMult(),lvl%10==0&&(player.xp+=100),player.checkIfNextLvl(),zzfxP(passDungeonSound[rng(passDungeonSound.length-1)]),player.resetActions(),createChatMessage("narrator","narrator",`${player.name} has reached level ${lvl} in ${steps} steps!`),buildDungeon(exit));if("room[nextX]?.[nextY]?.walkable && !room[nextX]?.[nextY]?.occupied"){if(player.awaitingUser=1,await tryAOO())return enemyTurn();for(;player.awaitingUser;){await checkIfWaiting()}if(enemies.length&&player.actionsLeft--,r[n][s].occupied=0,r[i][l].occupied=1,++steps,steps%30==0&&createChatMessage("narrator","narrator",narrator.taunting[rng(narrator.taunting.length)]),playerCoord=[i,l],player.coords=playerCoord,paintCanvas(),player.hiliteMoveArea(),player.checkFOV(),steps==Math.ceil(player.fov)&&!helpDisabled)for(window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.add("n-turn"),player.awaitingUser=!0,asyncForEach(narrator.fog,(e,r,t)=>new Promise(a=>{if(0==r)return createChatMessage("narrator","narrator",e),a();setTimeout(()=>{r!=t.length-1?(createChatMessage("narrator","narrator",e),a()):(createChatMessage("player",player.name,e),game.classList.remove("n-turn"),game.classList.add("p-turn"),player.awaitingUser=!1,a())},rng(750)+2e3)}));player.awaitingUser;){await checkIfWaiting()||window.addEventListener("keypress",handleKeyPress)}if(!firstEnemySpotted&&player.inRange.length&&!helpDisabled)for(window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.add("n-turn"),player.awaitingUser=!0,asyncForEach(narrator.enemy,(e,r,t)=>new Promise(a=>{if(0==r)return createChatMessage("narrator","narrator",e),a();setTimeout(()=>{r==t.length-1?(game.classList.remove("n-turn"),game.classList.add("p-turn"),player.awaitingUser=!1,firstEnemySpotted=1,createChatMessage("player",player.name,e)):createChatMessage("narrator","narrator",e),a()},rng(750)+1500)}));player.awaitingUser;){await checkIfWaiting()||window.addEventListener("keypress",handleKeyPress)}!player.actionsLeft&&enemies.length&&enemyTurn()}},goFullScreen=()=>{body.requestFullscreen?body.requestFullscreen():body.mozRequestFullScreen?body.mozRequestFullScreen():body.webkitRequestFullscreen?body.webkitRequestFullscreen():body.msRequestFullscreen&&body.msRequestFullscreen()},generateRandomEndpoint=([e,r],t)=>{let a=[];for(let t in COORDINATES)for(let n in COORDINATES[t])COORDINATES[t][n].border&&t!=e&&n!=r&&!COORDINATES[t][n].corner&&a.push([parseInt(t),parseInt(n)]);a=a.filter(([t,a])=>COORDINATES[t][a].quadrant!==COORDINATES[e][r].quadrant);return a[~~(Math.random()*a.length)]},paintCanvas=()=>{for(let e in COORDINATES)for(let r in COORDINATES[e]){inRange(player.coords,[e,r],player.fov)?(COORDINATES[e][r].hasBeenSeen=1,COORDINATES[e][r].inSight=1):COORDINATES[e][r].inSight=0;let{highlighted:t,occupied:a,walkable:n,hasBeenSeen:s,inSight:o,border:i,exit:l}=COORDINATES[e][r];const c=player.coords[0]==e&&player.coords[1]==r;ctx.clearRect(e,r,TILE_HEIGHT,TILE_HEIGHT),t&&(COORDINATES[e][r].highlighted=0),o?n?a?ctx.fillStyle=colors.inSight.enemy:n&&(ctx.fillStyle=l?getExitGradient(e,r):s?colors.inSight.walkable:colors.unseenOrUnwalkable):ctx.fillStyle=colors.unseenOrUnwalkable:ctx.fillStyle=s&&n?colors.outOfSight:colors.unseenOrUnwalkable,i&&!l&&(ctx.fillStyle=colors.unseenOrUnwalkable),c&&(ctx.fillStyle=colors.player),ctx.fillRect(e,r,TILE_HEIGHT,TILE_HEIGHT)}},enemyTurn=()=>{const e=["you ready?","it's my turn now!","I'm gonna get ya..."];window.removeEventListener("keypress",handleKeyPress),game.classList.remove("p-turn"),game.classList.remove("n-turn"),game.classList.add("e-turn"),moveTimer=setTimeout(()=>asyncForEach(enemies,(r,t)=>{const[a,n]=r.coords;return player.inRange.some(({coords:[e,r]})=>e==a&&r==n)&&createChatMessage("enemy",`#${t} - ${r.name}`,e[rng(e.length)]),r.block=0,new Promise(async e=>{for(;r.speedLeft>0;)await new Promise(e=>r.handleTurn(e,t));t==enemies.length-1&&setTimeout(()=>{window.addEventListener("keypress",handleKeyPress),game.classList.remove("e-turn"),game.classList.add("p-turn"),player.resetActions(),player.hiliteMoveArea()},300),setTimeout(()=>{r.resetActions(),e()},2e3)})}),500)},checkIfWaiting=()=>new Promise(e=>setTimeout(()=>player.awaitingUser?e(!0):e(!1),500)),getExitGradient=(e,r)=>{let t;return 0==e?t=ctx.createLinearGradient(-20,0,20,0):e==xyMax?t=ctx.createLinearGradient(240,0,260,0):0==r?t=ctx.createLinearGradient(0,-20,0,20):r==xyMax&&(t=ctx.createLinearGradient(0,240,0,260)),0==e||0==r?(t.addColorStop(.2,"black"),t.addColorStop(1,"yellow")):(t.addColorStop(1,"black"),t.addColorStop(0,"yellow")),t},gameOver=()=>{enemies=[];const e=setTimeout(()=>0,0);zzfxP(gameOverSound[rng(gameOverSound.length-1)]);for(let r=0;r<e;r++)clearTimeout(r);const r=[];for(let e in COORDINATES)for(let t in COORDINATES[e])!COORDINATES[e][t].border&&COORDINATES[e][t].hasBeenSeen&&r.push([e,t]);const t=setInterval(()=>{const e=rng(r.length),[a,n]=r[e];r.splice(e,1),ctx.fillStyle="black",ctx.fillRect(a,n,TILE_HEIGHT,TILE_HEIGHT),r.length<.2*CANVAS_HEIGHT&&_playAgain.classList.remove("invisible"),r.length||(ctx.fillRect(0,0,CANVAS_HEIGHT,CANVAS_HEIGHT),clearInterval(t))},500/TILE_HEIGHT);window.removeEventListener("keypress",handleKeyPress),asyncForEach(narrator.gameOver,(e,r,t)=>new Promise(a=>setTimeout(()=>{if(r!=t.length-1)return createChatMessage("narrator","narrator",e(player.name)),a();setTimeout(()=>a(),5e3)},rng(1e3)+2e3)))},setAttributes=(e,r)=>{for(let t in r)e.setAttribute(t,r[t])},createChatMessage=(e,r,t)=>{"player"===e?zzfxP(messageSound.player[rng(messageSound.player.length-1)]):"enemy"===e?zzfxP(messageSound.enemy[rng(messageSound.enemy.length-1)]):"narrator"===e&&zzfxP(messageSound.narrator[rng(messageSound.narrator.length-1)]);const a=document.createElement("div");a.classList.add("box","box-"+e);const n=document.createElement("p");n.classList.add("message-box","font-regular"),n.innerHTML=generateChatBorder()+t;const s=document.createElement("p");s.classList.add("author"),s.innerText=r,a.append(n,s),_chatMessageGroup.append(a),_chatBox.scrollTo(0,_chatBox.scrollHeight)},generateChatBorder=()=>`<svg width="100%" height="100%"><rect width='100%' height='100%' fill='none' stroke='black' stroke-width='7' stroke-dasharray=${rng(41)+40},${rng(31)+30},${rng(11)+20} stroke-dashoffset='84' stroke-linecap='square' /></svg>`,attackOfOpp=async(e,r)=>{const t=["going somewhere?  take this with you!","think you can just run do ya??",`You can run, ${player.name}....but you can't hide`];let a;return inRange(e.coords,player.coords,e.fov)?inRange(e.coords,player.coords,e.fov)?new Promise(n=>setTimeout(()=>{if(0==player.actionsLeft)return n();createChatMessage("enemy",""+e.name,t[rng(t.length)]),firstAOO=0,setTimeout(()=>{e.atkChar(()=>1,r,e=>a=e),player.awaitingUser=0,a?(player.actionsLeft=0,setTimeout(()=>{paintCanvas(),n(1)},2e3)):n()},1e3)},500)):void 0:new Promise(e=>e())},tryAOO=async()=>{if(enemies.some(e=>inRange(e.coords,player.coords,e.fov)&&e.playerSpotted&&e.hasBeenSpotted)){if(window.removeEventListener("keypress",handleKeyPress),firstAOO&&!helpDisabled)return void asyncForEach(narrator.aoo,(e,r,t)=>new Promise(a=>setTimeout(()=>{0==r?createChatMessage("narrator","narrator",e(player.name)):1==r?createChatMessage("player",player.name,e):(createChatMessage("narrator","narrator",e),r==t.length-1&&setTimeout(()=>{player.awaitingUser=0,firstAOO=0,window.addEventListener("keypress",handleKeyPress),a()},2e3)),r!=t.length-1&&a()},0==r?1:rng(1e3)+1500)));let e;for(let r=0;r<enemies.length;r++)await attackOfOpp(enemies[r],r,enemies)&&(e=1);return window.addEventListener("keypress",handleKeyPress),e?1:void 0}player.awaitingUser=0};